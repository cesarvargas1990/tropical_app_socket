name: Laravel

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: laravel-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tests:
    name: Tests (PHP 8.4)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          tools: composer:v2
          coverage: pcov
          extensions: mbstring, pdo_sqlite

      - name: Show versions
        run: |
          php -v
          composer -V

      - name: Prepare .env
        run: |
          if [ ! -f .env ]; then
            cp .env.example .env
          fi

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache/files
          key: ${{ runner.os }}-php-8.4-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-8.4-composer-

      - name: Install dependencies
        run: composer install --no-interaction --no-progress --prefer-dist

      - name: Lint (Pint)
        run: ./vendor/bin/pint --test

      - name: Format check (Pint)
        run: ./vendor/bin/pint --test

      - name: Generate app key
        run: php artisan key:generate --force

      - name: Create SQLite database
        run: |
          mkdir -p database
          touch database/database.sqlite

      - name: Fix permissions
        run: chmod -R 777 storage bootstrap/cache

      - name: Run migrations
        env:
          APP_ENV: testing
          APP_DEBUG: true

          # DB sqlite para CI
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite

          # ✅ BLINDAJE anti-Redis (Laravel viejo + nuevo)
          CACHE_DRIVER: array
          CACHE_STORE: array

          # ✅ Spatie Permission cache store
          PERMISSION_CACHE_STORE: array

          # ✅ evita sesiones/colas externas
          SESSION_DRIVER: array
          QUEUE_CONNECTION: sync

          # opcional por seguridad
          BROADCAST_DRIVER: log
          MAIL_MAILER: log

          # por si el .env trae cosas raras (no deberían usarse igual)
          REDIS_HOST: 127.0.0.1
          REDIS_PORT: 6379
        run: php artisan migrate --force

      - name: Run tests (with coverage)
        env:
          APP_ENV: testing
          APP_DEBUG: true

          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite

          CACHE_DRIVER: array
          CACHE_STORE: array
          PERMISSION_CACHE_STORE: array

          SESSION_DRIVER: array
          QUEUE_CONNECTION: sync
        run: php artisan test --coverage-clover=coverage.xml

      - name: SonarQube scan
        uses: sonarsource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
